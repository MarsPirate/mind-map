<template>
  <div class="editContainer" :style="{ top: IS_ELECTRON ? '40px' : 0 }" @dragenter.stop.prevent="onDragenter"
    @dragleave.stop.prevent @dragover.stop.prevent @drop.stop.prevent>
    <div class="mindMapContainer" id="mindMapContainer" ref="mindMapContainer"></div>
    <Count :mindMap="mindMap" v-if="!isZenMode"></Count>
    <Navigator v-if="mindMap" :mindMap="mindMap"></Navigator>
    <NavigatorToolbar :mindMap="mindMap" v-if="!isZenMode"></NavigatorToolbar>
    <OutlineSidebar :mindMap="mindMap"></OutlineSidebar>
    <Style v-if="!isZenMode"></Style>
    <BaseStyle :data="mindMapData" :mindMap="mindMap"></BaseStyle>
    <AssociativeLineStyle v-if="mindMap" :mindMap="mindMap"></AssociativeLineStyle>
    <Theme v-if="mindMap" :data="mindMapData" :mindMap="mindMap"></Theme>
    <Structure :mindMap="mindMap"></Structure>
    <ShortcutKey></ShortcutKey>
    <Contextmenu v-if="mindMap" :mindMap="mindMap"></Contextmenu>
    <RichTextToolbar v-if="mindMap" :mindMap="mindMap"></RichTextToolbar>
    <NodeNoteContentShow v-if="mindMap" :mindMap="mindMap"></NodeNoteContentShow>
    <NodeAttachment v-if="mindMap" :mindMap="mindMap"></NodeAttachment>
    <NodeImgPreview v-if="mindMap" :mindMap="mindMap"></NodeImgPreview>
    <SidebarTrigger v-if="!isZenMode"></SidebarTrigger>
    <Search v-if="mindMap" :mindMap="mindMap"></Search>
    <NodeIconSidebar v-if="mindMap" :mindMap="mindMap"></NodeIconSidebar>
    <NodeIconToolbar v-if="mindMap" :mindMap="mindMap"></NodeIconToolbar>
    <OutlineEdit v-if="mindMap" :mindMap="mindMap"></OutlineEdit>
    <Scrollbar v-if="isShowScrollbar && mindMap" :mindMap="mindMap"></Scrollbar>
    <FormulaSidebar v-if="mindMap" :mindMap="mindMap"></FormulaSidebar>
    <SourceCodeEdit v-if="mindMap" :mindMap="mindMap"></SourceCodeEdit>
    <NodeOuterFrame v-if="mindMap" :mindMap="mindMap"></NodeOuterFrame>
    <NodeTagStyle v-if="mindMap" :mindMap="mindMap"></NodeTagStyle>
    <Setting :data="mindMapData" :mindMap="mindMap"></Setting>
    <NodeImgPlacementToolbar v-if="mindMap" :mindMap="mindMap"></NodeImgPlacementToolbar>
    <AiCreate v-if="mindMap && enableAi" :mindMap="mindMap"></AiCreate>
    <AiChat v-if="enableAi"></AiChat>
    <div class="dragMask" v-if="showDragMask" @dragleave.stop.prevent="onDragleave" @dragover.stop.prevent
      @drop.stop.prevent="onDrop">
      <div class="dragTip">{{ $t('edit.dragTip') }}</div>
    </div>
  </div>
</template>

<script>
import MindMap from 'simple-mind-map'
import MiniMap from 'simple-mind-map/src/plugins/MiniMap.js'
import Watermark from 'simple-mind-map/src/plugins/Watermark.js'
import KeyboardNavigation from 'simple-mind-map/src/plugins/KeyboardNavigation.js'
import ExportPDF from 'simple-mind-map/src/plugins/ExportPDF.js'
import ExportXMind from 'simple-mind-map/src/plugins/ExportXMind.js'
import Export from 'simple-mind-map/src/plugins/Export.js'
import Drag from 'simple-mind-map/src/plugins/Drag.js'
import Select from 'simple-mind-map/src/plugins/Select.js'
import RichText from 'simple-mind-map/src/plugins/RichText.js'
import AssociativeLine from 'simple-mind-map/src/plugins/AssociativeLine.js'
import TouchEvent from 'simple-mind-map/src/plugins/TouchEvent.js'
import NodeImgAdjust from 'simple-mind-map/src/plugins/NodeImgAdjust.js'
import SearchPlugin from 'simple-mind-map/src/plugins/Search.js'
import {
  downloadFile,
  readBlob,
  simpleDeepClone
} from 'simple-mind-map/src/utils/index'
import Painter from 'simple-mind-map/src/plugins/Painter.js'
import ScrollbarPlugin from 'simple-mind-map/src/plugins/Scrollbar.js'
import Formula from 'simple-mind-map/src/plugins/Formula.js'
import RainbowLines from 'simple-mind-map/src/plugins/RainbowLines.js'
import Demonstrate from 'simple-mind-map/src/plugins/Demonstrate.js'
import OuterFrame from 'simple-mind-map/src/plugins/OuterFrame.js'
import MindMapLayoutPro from 'simple-mind-map/src/plugins/MindMapLayoutPro.js'
import Themes from 'simple-mind-map-plugin-themes'
// 协同编辑插件
// import Cooperate from 'simple-mind-map/src/plugins/Cooperate.js'
// 以下插件为付费插件，详情请查看开发文档。依次为：手绘风格插件、标记插件、编号插件、Freemind软件格式导入导出插件、Excel软件格式导入导出插件、待办插件、节点连线流动效果插件、动量效果插件
import HandDrawnLikeStyle from 'simple-mind-map-plugin-handdrawnlikestyle'
import Notation from 'simple-mind-map-plugin-notation'
import Numbers from 'simple-mind-map-plugin-numbers'
import Freemind from 'simple-mind-map-plugin-freemind'
import Excel from 'simple-mind-map-plugin-excel'
import Checkbox from 'simple-mind-map-plugin-checkbox'
import LineFlow from 'simple-mind-map-plugin-lineflow'
import Momentum from 'simple-mind-map-plugin-momentum'
// npm link simple-mind-map-plugin-excel simple-mind-map-plugin-freemind simple-mind-map-plugin-numbers simple-mind-map-plugin-notation simple-mind-map-plugin-handdrawnlikestyle simple-mind-map-plugin-checkbox simple-mind-map simple-mind-map-plugin-themes simple-mind-map-plugin-lineflow simple-mind-map-plugin-momentum
import OutlineSidebar from './OutlineSidebar.vue'
import Style from './Style.vue'
import BaseStyle from './BaseStyle.vue'
import Theme from './Theme.vue'
import Structure from './Structure.vue'
import Count from './Count.vue'
import NavigatorToolbar from './NavigatorToolbar.vue'
import ShortcutKey from './ShortcutKey.vue'
import Contextmenu from './Contextmenu.vue'
import RichTextToolbar from './RichTextToolbar.vue'
import NodeNoteContentShow from './NodeNoteContentShow.vue'
import { getData, storeData, storeConfig, getConfig } from '@/api'
import Navigator from './Navigator.vue'
import NodeImgPreview from './NodeImgPreview.vue'
import SidebarTrigger from './SidebarTrigger.vue'
import { mapState, mapMutations } from 'vuex'
import icon from '@/config/icon'
import Vue from 'vue'
import Search from './Search.vue'
import NodeIconSidebar from './NodeIconSidebar.vue'
import NodeIconToolbar from './NodeIconToolbar.vue'
import {
  removeMindMapNodeStickerProtocol,
  addMindMapNodeStickerProtocol,
  getFileName
} from '@/utils'
import OutlineEdit from './OutlineEdit.vue'
import { showLoading, hideLoading } from '@/utils/loading'
import handleClipboardText from '@/utils/handleClipboardText'
import Scrollbar from './Scrollbar.vue'
import exampleData from 'simple-mind-map/example/exampleData'
import FormulaSidebar from './FormulaSidebar.vue'
import SourceCodeEdit from './SourceCodeEdit.vue'
import NodeAttachment from './NodeAttachment.vue'
import NodeOuterFrame from './NodeOuterFrame.vue'
import NodeTagStyle from './NodeTagStyle.vue'
import Setting from './Setting.vue'
import AssociativeLineStyle from './AssociativeLineStyle.vue'
import NodeImgPlacementToolbar from './NodeImgPlacementToolbar.vue'
import { getClientConfig, saveToRecent } from '@/utils/storage'
import AiCreate from './AiCreate.vue'
import AiChat from './AiChat.vue'

// 注册插件
MindMap.usePlugin(MiniMap)
  .usePlugin(Watermark)
  .usePlugin(Drag)
  .usePlugin(KeyboardNavigation)
  .usePlugin(ExportPDF)
  .usePlugin(ExportXMind)
  .usePlugin(Export)
  .usePlugin(Select)
  .usePlugin(AssociativeLine)
  .usePlugin(NodeImgAdjust)
  .usePlugin(TouchEvent)
  .usePlugin(SearchPlugin)
  .usePlugin(Painter)
  .usePlugin(Formula)
  .usePlugin(RainbowLines)
  .usePlugin(Demonstrate)
  .usePlugin(OuterFrame)
  .usePlugin(MindMapLayoutPro)
// .usePlugin(Cooperate) // 协同插件

// 注册主题
Themes.init(MindMap)

export default {
  components: {
    OutlineSidebar,
    Style,
    BaseStyle,
    Theme,
    Structure,
    Count,
    NavigatorToolbar,
    ShortcutKey,
    Contextmenu,
    RichTextToolbar,
    NodeNoteContentShow,
    Navigator,
    NodeImgPreview,
    SidebarTrigger,
    Search,
    NodeIconSidebar,
    NodeIconToolbar,
    OutlineEdit,
    Scrollbar,
    FormulaSidebar,
    SourceCodeEdit,
    NodeAttachment,
    NodeOuterFrame,
    NodeTagStyle,
    Setting,
    AssociativeLineStyle,
    NodeImgPlacementToolbar,
    AiCreate,
    AiChat
  },
  data() {
    return {
      enableShowLoading: true,
      mindMap: null,
      mindMapData: null,
      prevImg: '',
      isFirst: true,
      autoSaveTimer: null,
      isNewFile: false,
      storeConfigTimer: null,
      showDragMask: false,
      lastViewData: null,
      clientConfig: null
    }
  },
  computed: {
    ...mapState({
      fileName: state => state.fileName,
      filePath: state => state.filePath,
      isZenMode: state => state.localConfig.isZenMode,
      openNodeRichText: state => state.localConfig.openNodeRichText,
      isShowScrollbar: state => state.localConfig.isShowScrollbar,
      enableDragImport: state => state.localConfig.enableDragImport,
      useLeftKeySelectionRightKeyDrag: state =>
        state.localConfig.useLeftKeySelectionRightKeyDrag,
      isUseHandDrawnLikeStyle: state =>
        state.localConfig.isUseHandDrawnLikeStyle,
      isUseMomentum: state => state.localConfig.isUseMomentum,
      extraTextOnExport: state => state.extraTextOnExport,
      isDragOutlineTreeNode: state => state.isDragOutlineTreeNode,
      currentFolder: state => state.currentFolder,
      isDark: state => state.localConfig.isDark,
      enableAi: state => state.localConfig.enableAi,
      isVIP: state => state.isVIP
    })
  },
  watch: {
    openNodeRichText() {
      if (this.openNodeRichText) {
        this.addRichTextPlugin()
      } else {
        this.removeRichTextPlugin()
      }
    },
    isShowScrollbar() {
      if (this.isShowScrollbar) {
        this.addScrollbarPlugin()
      } else {
        this.removeScrollbarPlugin()
      }
    },
    isUseHandDrawnLikeStyle() {
      if (this.isUseHandDrawnLikeStyle) {
        this.addHandDrawnLikeStylePlugin()
      } else {
        this.removeHandDrawnLikeStylePlugin()
      }
    },
    isUseMomentum() {
      if (this.isUseMomentum) {
        this.addMomentumPlugin()
      } else {
        this.removeMomentumPlugin()
      }
    }
  },
  async mounted() {
    showLoading()
    await this.getData()
    this.init()
    this.$bus.$on('execCommand', this.execCommand)
    this.$bus.$on('paddingChange', this.onPaddingChange)
    this.$bus.$on('export', this.export)
    this.$bus.$on('exportJson', this.exportJson)
    this.$bus.$on('setData', this.setData)
    this.$bus.$on('startTextEdit', this.handleStartTextEdit)
    this.$bus.$on('endTextEdit', this.handleEndTextEdit)
    this.$bus.$on('createAssociativeLine', this.handleCreateLineFromActiveNode)
    this.$bus.$on('startPainter', this.handleStartPainter)
    this.$bus.$on('node_tree_render_end', this.handleHideLoading)
    this.$bus.$on('showLoading', this.handleShowLoading)
    window.addEventListener('resize', this.handleResize)
    if (window.IS_ELECTRON) {
      this.mindMap.keyCommand.addShortcut('Control+s', this.saveToLocal)
      this.$bus.$on('saveToLocal', this.saveToLocal)
    }
    Vue.prototype.$bus.$on('set_unsave', this.onSetUnsave)
  },
  beforeDestroy() {
    this.$bus.$off('execCommand', this.execCommand)
    this.$bus.$off('paddingChange', this.onPaddingChange)
    this.$bus.$off('export', this.export)
    this.$bus.$off('exportJson', this.exportJson)
    this.$bus.$off('setData', this.setData)
    this.$bus.$off('startTextEdit', this.handleStartTextEdit)
    this.$bus.$off('endTextEdit', this.handleEndTextEdit)
    this.$bus.$off('createAssociativeLine', this.handleCreateLineFromActiveNode)
    this.$bus.$off('startPainter', this.handleStartPainter)
    this.$bus.$off('node_tree_render_end', this.handleHideLoading)
    this.$bus.$off('showLoading', this.handleShowLoading)
    window.removeEventListener('resize', this.handleResize)
    if (window.IS_ELECTRON) {
      this.mindMap.keyCommand.removeShortcut('Control+s')
      this.$bus.$off('saveToLocal', this.saveToLocal)
    }
    this.unBindSaveEvent()
    this.mindMap.destroy()
    clearTimeout(this.autoSaveTimer)
    Vue.prototype.$bus.$off('set_unsave', this.onSetUnsave)
  },
  methods: {
    ...mapMutations(['setFileName', 'setIsUnSave', 'setFilePath']),

    handleStartTextEdit() {
      this.mindMap.renderer.startTextEdit()
    },

    handleEndTextEdit() {
      this.mindMap.renderer.endTextEdit()
    },

    handleCreateLineFromActiveNode() {
      this.mindMap.associativeLine.createLineFromActiveNode()
    },

    handleStartPainter() {
      this.mindMap.painter.startPainter()
    },

    handleResize() {
      this.mindMap.resize()
    },

    // 显示loading
    handleShowLoading() {
      this.enableShowLoading = true
      showLoading()
    },

    // 渲染结束后关闭loading
    handleHideLoading() {
      if (this.enableShowLoading) {
        this.enableShowLoading = false
        hideLoading()
      }
    },

    /**
     * @Author: 王林
     * @Date: 2021-07-03 22:11:37
     * @Desc: 获取思维导图数据，实际应该调接口获取
     */
    async getData() {
      let data = null
      if (this.filePath) {
        data = await window.electronAPI.getFileContent(this.filePath)
      }
      this.clientConfig = getClientConfig() || {}
      const defaultTheme = this.clientConfig.theme || 'classic4'
      const defaultLayout = this.clientConfig.layout || 'logicalStructure'
      let storeData = null
      if (data) {
        this.setFileName(data.name)
        if (data.content) {
          if (!data.content.root) {
            data = {
              content: {
                root: data.content,
                layout: defaultLayout,
                theme: {
                  template: defaultTheme,
                  config: {}
                }
              }
            }
          }
          addMindMapNodeStickerProtocol(data.content.root)
          storeData = data.content
        } else {
          this.$message.info(this.$t('edit.emptyTip'))
          storeData = simpleDeepClone(exampleData)
          storeData.layout = defaultLayout
          storeData.theme = {
            template: defaultTheme,
            config: {}
          }
        }
      } else {
        this.isNewFile = true
        this.setFileName('未命名')
        storeData = getData()
        storeData.layout = defaultLayout
        storeData.theme = {
          template: defaultTheme,
          config: {}
        }
      }
      storeData.config = getConfig()
      this.mindMapData = storeData
    },

    // 存储数据当数据有变时
    bindSaveEvent() {
      this.$bus.$on('data_change', this.onDataChange)
      this.$bus.$on('view_data_change', this.onViewDataChange)
    },

    unBindSaveEvent() {
      this.$bus.$off('data_change', this.onDataChange)
      this.$bus.$off('view_data_change', this.onViewDataChange)
    },

    // 思维导图数据改变
    onDataChange(data) {
      if (!this.isFirst) {
        this.autoSave()
        this.setIsUnSave(true)
      } else {
        this.isFirst = false
      }
      storeData(data)
    },

    // 自动保存
    autoSave() {
      clearTimeout(this.autoSaveTimer)
      this.autoSaveTimer = setTimeout(() => {
        if (this.$route.name !== 'WorkbencheEdit') return
        if (this.isNewFile) return
        this.saveToLocal()
      }, 5000)
    },

    onViewDataChange(data) {
      if (
        (!this.clientConfig ||
          !this.clientConfig.viewTranslateChangeTriggerAutoSave) &&
        this.lastViewData.transform.scaleX === data.transform.scaleX &&
        this.lastViewData.transform.scaleY === data.transform.scaleY
      ) {
        this.lastViewData = simpleDeepClone(data)
        return
      }
      this.lastViewData = simpleDeepClone(data)
      this.autoSave()
      this.setIsUnSave(true)
      clearTimeout(this.storeConfigTimer)
      this.storeConfigTimer = setTimeout(() => {
        storeConfig({
          view: data
        })
      }, 300)
    },

    /**
     * @Author: 王林
     * @Date: 2021-08-02 23:19:52
     * @Desc: 手动保存
     */
    // 手动保存
    manualSave() {
      let data = this.mindMap.getData(true)
      storeConfig(data)
    },

    // 初始化
    init() {
      let hasFileURL = this.hasFileURL()
      let { root, layout, theme, view, config } = this.mindMapData
      // 如果url中存在要打开的文件，那么思维导图数据、主题、布局都使用默认的
      if (hasFileURL) {
        root = {
          data: {
            text: this.$t('edit.root')
          },
          children: []
        }
        layout = exampleData.layout
        theme = exampleData.theme
        view = null
      }
      this.mindMap = new MindMap({
        el: this.$refs.mindMapContainer,
        data: root,
        fit: false,
        layout: layout,
        theme: theme.template,
        themeConfig: theme.config,
        viewData: view,
        nodeTextEditZIndex: 1000,
        nodeNoteTooltipZIndex: 1000,
        customNoteContentShow: {
          show: (content, left, top, node) => {
            this.$bus.$emit('showNoteContent', content, left, top, node)
          },
          hide: () => {
            // this.$bus.$emit('hideNoteContent')
          }
        },
        openRealtimeRenderOnNodeTextEdit: true,
        enableAutoEnterTextEditWhenKeydown: true,
        ...(config || {}),
        iconList: [...icon],
        useLeftKeySelectionRightKeyDrag: this.useLeftKeySelectionRightKeyDrag,
        customInnerElsAppendTo: null,
        customHandleClipboardText: handleClipboardText,
        defaultNodeImage: require('../../../assets/img/图片加载失败.svg'),
        initRootNodePosition: ['center', 'center'],
        handleIsSplitByWrapOnPasteCreateNewNode: () => {
          return this.$confirm(
            this.$t('edit.splitByWrap'),
            this.$t('edit.tip'),
            {
              confirmButtonText: this.$t('edit.yes'),
              cancelButtonText: this.$t('edit.no'),
              type: 'warning',
              customClass: this.isDark ? 'darkElMessageBox' : ''
            }
          )
        },
        errorHandler: (code, err) => {
          console.error(err)
          switch (code) {
            case 'export_error':
              this.$message.error(this.$t('edit.exportError'))
              break
            default:
              break
          }
        },
        addContentToFooter: () => {
          const text = this.extraTextOnExport.trim()
          if (!text) return null
          const el = document.createElement('div')
          el.className = 'footer'
          el.innerHTML = text
          const cssText = `
            .footer {
              width: 100%;
              height: 30px;
              display: flex;
              justify-content: center;
              align-items: center;
              font-size: 12px;
              color: #979797;
            }
          `
          return {
            el,
            cssText,
            height: 30
          }
        },
        expandBtnNumHandler: num => {
          return num >= 100 ? '…' : num
        },
        beforeDeleteNodeImg: node => {
          return new Promise(resolve => {
            this.$confirm(
              this.$t('edit.deleteNodeImgTip'),
              this.$t('edit.tip'),
              {
                confirmButtonText: this.$t('edit.yes'),
                cancelButtonText: this.$t('edit.no'),
                type: 'warning',
                customClass: this.isDark ? 'darkElMessageBox' : ''
              }
            )
              .then(() => {
                resolve(false)
              })
              .catch(() => {
                resolve(true)
              })
          })
        },
        customHyperlinkJump(link) {
          utools.shellOpenExternal(link)
        },
        getKatexOutputType() {
          return 'html'
        }
      })
      this.lastViewData = simpleDeepClone(this.mindMap.view.getTransformData())
      this.loadPlugins()
      this.mindMap.keyCommand.addShortcut('Control+s', () => {
        this.manualSave()
      })
        // 转发事件
        ;[
          'node_active',
          'data_change',
          'view_data_change',
          'back_forward',
          'node_contextmenu',
          'node_click',
          'draw_click',
          'expand_btn_click',
          'svg_mousedown',
          'mouseup',
          'mode_change',
          'node_tree_render_end',
          'rich_text_selection_change',
          'transforming-dom-to-images',
          'generalization_node_contextmenu',
          'painter_start',
          'painter_end',
          'scrollbar_change',
          'scale',
          'translate',
          'node_attachmentClick',
          'node_attachmentContextmenu',
          'demonstrate_jump',
          'exit_demonstrate',
          'node_note_dblclick',
          'node_mousedown'
        ].forEach(event => {
          this.mindMap.on(event, (...args) => {
            this.$bus.$emit(event, ...args)
          })
        })
      this.bindSaveEvent()
      // 如果应用被接管，那么抛出事件传递思维导图实例
      if (window.takeOverApp) {
        this.$bus.$emit('app_inited', this.mindMap)
      }
      // 解析url中的文件
      if (hasFileURL) {
        this.$bus.$emit('handle_file_url')
      }
      // api/index.js文件使用
      // 当正在编辑本地文件时通过该方法获取最新数据
      Vue.prototype.getCurrentData = () => {
        const fullData = this.mindMap.getData(true)
        return { ...fullData, config: this.mindMapData.config }
      }
    },

    // 加载相关插件
    loadPlugins() {
      if (this.openNodeRichText) this.addRichTextPlugin()
      if (this.isShowScrollbar) this.addScrollbarPlugin()
      if (this.isVIP) {
        if (typeof HandDrawnLikeStyle !== 'undefined') {
          this.$store.commit('setSupportHandDrawnLikeStyle', true)
          if (this.isUseHandDrawnLikeStyle) this.addHandDrawnLikeStylePlugin()
        }
        if (typeof Momentum !== 'undefined') {
          this.$store.commit('setSupportMomentum', true)
          if (this.isUseMomentum) this.addMomentumPlugin()
        }
        if (typeof Notation !== 'undefined') {
          this.mindMap.addPlugin(Notation)
          this.$store.commit('setSupportMark', true)
        }
        if (typeof Numbers !== 'undefined') {
          this.mindMap.addPlugin(Numbers)
          this.$store.commit('setSupportNumbers', true)
        }
        if (typeof Freemind !== 'undefined') {
          this.mindMap.addPlugin(Freemind)
          this.$store.commit('setSupportFreemind', true)
          Vue.prototype.Freemind = Freemind
        }
        if (typeof Excel !== 'undefined') {
          this.mindMap.addPlugin(Excel)
          this.$store.commit('setSupportExcel', true)
          Vue.prototype.Excel = Excel
        }
        if (typeof Checkbox !== 'undefined') {
          this.mindMap.addPlugin(Checkbox)
          this.$store.commit('setSupportCheckbox', true)
        }
        if (typeof LineFlow !== 'undefined') {
          this.mindMap.addPlugin(LineFlow)
          this.$store.commit('setSupportLineFlow', true)
        }
      }
    },

    // url中是否存在要打开的文件
    hasFileURL() {
      const fileURL = this.$route.query.fileURL
      if (!fileURL) return false
      return /\.(smm|json|xmind|md|xlsx)$/.test(fileURL)
    },

    // 动态设置思维导图数据
    setData(data) {
      this.handleShowLoading()
      let rootNodeData = null
      if (data.root) {
        this.mindMap.setFullData(data)
        rootNodeData = data.root
      } else {
        this.mindMap.setData(data)
        rootNodeData = data
      }
      this.mindMap.view.reset()
      this.manualSave()
      // 如果导入的是富文本内容，那么自动开启富文本模式
      if (rootNodeData.data.richText && !this.openNodeRichText) {
        this.$bus.$emit('toggleOpenNodeRichText', true)
        this.$notify.info({
          title: this.$t('edit.tip'),
          message: this.$t('edit.autoOpenNodeRichTextTip')
        })
      }
    },

    // 重新渲染
    reRender() {
      this.mindMap.reRender()
    },

    // 执行命令
    execCommand(...args) {
      this.mindMap.execCommand(...args)
    },

    // 导出
    async export(...args) {
      try {
        showLoading()
        await this.mindMap.export(...args)
        hideLoading()
      } catch (error) {
        console.log(error)
        hideLoading()
      }
    },

    async exportJson(type, isDownload = true, name = '思维导图', withConfig) {
      let data = this.mindMap.getData(withConfig)
      removeMindMapNodeStickerProtocol(data.root ? data.root : data)
      let str = JSON.stringify(data)
      let blob = new Blob([str])
      let res = await readBlob(blob)
      if (isDownload) {
        downloadFile(res, name + '.' + type)
      }
    },

    // 修改导出内边距
    onPaddingChange(data) {
      this.mindMap.updateConfig(data)
    },

    // 加载节点富文本编辑插件
    addRichTextPlugin() {
      if (!this.mindMap) return
      this.mindMap.addPlugin(RichText)
    },

    // 移除节点富文本编辑插件
    removeRichTextPlugin() {
      this.mindMap.removePlugin(RichText)
    },

    // 监听是否保存
    onSetUnsave(isUnsave) {
      this.setIsUnSave(isUnsave)
    },

    // 保存到本地文件
    async saveToLocal() {
      let data = this.mindMap.getData(true)
      removeMindMapNodeStickerProtocol(data.root)
      data = JSON.stringify(data)
      if (!this.filePath) {
        const res = utools.showSaveDialog({
          title: '保存',
          defaultPath:
            (this.currentFolder ? this.currentFolder + '/' : '') +
            this.fileName +
            '.smm',
          filters: [{ name: '思维导图', extensions: ['smm'] }]
        })
        if (res) {
          try {
            this.setFilePath(res)
            await window.electronAPI.save(res, data)
            this.isNewFile = false
            const fileName = getFileName(res)
            this.setFileName(fileName)
            this.setIsUnSave(false)
            await saveToRecent(res)
            this.$bus.$emit('refreshRecentFileList')
          } catch (error) {
            this.$message.error('保存失败')
            console.log(error)
          }
        }
      } else {
        try {
          await window.electronAPI.save(this.filePath, data)
          this.setIsUnSave(false)
        } catch (error) {
          this.$message.error('保存失败')
          console.log(error)
        }
      }
    },

    // 加载滚动条插件
    addScrollbarPlugin() {
      if (!this.mindMap) return
      this.mindMap.addPlugin(ScrollbarPlugin)
    },

    // 移除滚动条插件
    removeScrollbarPlugin() {
      this.mindMap.removePlugin(ScrollbarPlugin)
    },

    // 加载手绘风格插件
    addHandDrawnLikeStylePlugin() {
      try {
        if (!this.mindMap) return
        this.mindMap.addPlugin(HandDrawnLikeStyle)
        this.mindMap.reRender()
      } catch (error) {
        console.log('手绘风格插件不存在')
      }
    },

    // 移除手绘风格插件
    removeHandDrawnLikeStylePlugin() {
      try {
        this.mindMap.removePlugin(HandDrawnLikeStyle)
        this.mindMap.reRender()
      } catch (error) {
        console.log('手绘风格插件不存在')
      }
    },

    // 加载动量效果插件
    addMomentumPlugin() {
      try {
        if (!this.mindMap) return
        this.mindMap.addPlugin(Momentum)
      } catch (error) {
        console.log('动量效果插件不存在')
      }
    },

    // 移除动量效果插件
    removeMomentumPlugin() {
      try {
        this.mindMap.removePlugin(Momentum)
      } catch (error) {
        console.log('动量效果插件不存在')
      }
    },

    // 拖拽文件到页面导入
    onDragenter() {
      if (!this.enableDragImport || this.isDragOutlineTreeNode) return
      this.showDragMask = true
    },
    onDragleave() {
      this.showDragMask = false
    },
    onDrop(e) {
      if (!this.enableDragImport) return
      this.showDragMask = false
      const dt = e.dataTransfer
      const file = dt.files && dt.files[0]
      if (!file) return
      this.$bus.$emit('importFile', file)
    }
  }
}
</script>

<style lang="less" scoped>
.editContainer {
  position: fixed;
  left: 0;
  right: 0;
  top: 0;
  bottom: 0;

  .dragMask {
    position: absolute;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(255, 255, 255, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 3999;

    .dragTip {
      pointer-events: none;
      font-weight: bold;
    }
  }

  .mindMapContainer {
    position: absolute;
    left: 0px;
    top: 0px;
    width: 100%;
    height: 100%;

    // left: 100px;
    // top: 100px;
    // right: 100px;
    // bottom: 100px;
  }
}
</style>
